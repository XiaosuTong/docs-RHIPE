### Compute County Min, Median, Max ###

We calculate the min, median, and max of list price by county and them we collect all statistics 
of list price of counties for every state, and create a `data.frame` for each state. 

#### The Map R Code ####

```{r eval=FALSE, tidy=FALSE}
map4 <- expression({
  lapply(seq_along(map.keys), function(r) {
    outputvalue <- data.frame(
      FIPS = map.keys[[r]],
      county = attr(map.values[[r]], "county"),
      min = min(map.values[[r]]$list, na.rm = TRUE),
      median = median(map.values[[r]]$list, na.rm = TRUE),
      max = max(map.values[[r]]$list, na.rm = TRUE),
      stringsAsFactors = FALSE
    )
    outputkey <- attr(map.values[[r]], "state")
    rhcollect(outputkey, outputvalue)
  })
})
```

In the map expression, we create a single row data frame `outputvalue` for each county. The data frame has five
columns: FIPS code, county name, min of list price, median of list price, and max of list price. 
FIPS code and county name can be found in the attributes of each element of `map.values`. Recall 
that those attributes are created in last session when we created county divisions.
In order to combine  by county into one data frame for each state, we will assign the state name
which also can be found in the attributes named "state" in each element of `map.values` to be the 
`outputkey` for all output key-value pairs.

#### The Reduce R Code ####

```{r eval=FALSE, tidy=FALSE}
reduce4 <- expression(
  pre = {
    reduceoutputvalue <- data.frame()
  },
  reduce = {
    reduceoutputvalue <- rbind(reduceoutputvalue, do.call(rbind, reduce.values))
  },
  post = {
    rhcollect(reduce.key, reduceoutputvalue)
  }
)
```

We can use almost the same reduce expression which we used previously. In the reduce expression 
above, our goal is to combine all observations associated with one particular state into a single 
`data.frame`.  In `pre`, we initialize an empty data frame, `reduceoutputvalue`. In `reduce`, we 
use `rbind` to combine all counties with their min, median, and max associated with one particular 
state.  In `post`, we just emit the final key-value pair.  The key is the state name, and the value 
is the data frame with all counties belonging to that state. These final key-value pairs are written 
to HDFS, and will persist for subsequent analyses.


#### Execution Function ####

```{r eval=FALSE, tidy=FALSE}
CountyStats <- rhwatch(
  map      = map4,
  reduce   = reduce4,
  input    = rhfmt("/yourloginname/housing/byCounty", type = "sequence"),
  output   = rhfmt("/yourloginname/housing/CountyStats", type = "sequence"),
  mapred   = list( 
    mapred.reduce.tasks = 10
  ),
  readback = TRUE
)
```

This time we specify the `readback` argument to be `TRUE` in `rhwatch()` function. By doing this,
once the job is finished, the output of the job which is one `data.frame` for each state will be 
read back and assigned to `countyStats` automatically. So we do not nead to use `rhread()` anymore.

```{r eval=FALSE, tidy=FALSE}
str(CountyStats)
```
```
List of 49
 $ :List of 2
  ..$ : chr "AL"
  ..$ :'data.frame':  64 obs. of  5 variables:
  .. ..$ min   : num [1:64] 34.9 94.7 83.9 92.9 60.3 ...
  .. ..$ median: num [1:64] 51.9 99.2 88.6 97.5 72.5 ...
  .. ..$ max   : num [1:64] 73.5 102.2 94.7 105.7 93.5 ...
  .. ..$ FIPS  : chr [1:64] "01093" "01051" "01031" "01125" ...
  .. ..$ county: chr [1:64] "Marion" "Elmore" "Coffee" "Tuscaloosa" ...
 $ :List of 2
  ..$ : chr "AR"
  ..$ :'data.frame':	71 obs. of  5 variables:
  .. ..$ min   : num [1:71] 64.916 0.548 58.333 31.409 92.222 ...
  .. ..$ median: num [1:71] 84.3 59.6 68.4 40 95.9 ...
  .. ..$ max   : num [1:71] 97.9 222 75.9 46.2 105.2 ...
  .. ..$ FIPS  : chr [1:71] "05105" "05079" "05071" "05011" ...
  .. ..$ county: chr [1:71] "Perry" "Lincoln" "Johnson" "Bradley" ...
......
```

We can access the key of the first key-value pair by

```{r eval=FALSE, tidy=FALSE}
CountyStats[[1]][[2]]
```
```
[1] "AL"
```
And the `data.frame` for state "AL" is:

```{r eval=FALSE, tidy=FALSE}
head(CountyStats[[1]][[2]])
```
```
        min    median       max  FIPS     county
1  34.88372  51.88628  73.46257 01093     Marion
2  94.66667  99.20582 102.23077 01051     Elmore
3  83.93817  88.59977  94.67041 01031     Coffee
4  92.87617  97.53306 105.71429 01125 Tuscaloosa
5  60.34774  72.46377  93.53741 01027       Clay
6 108.97167 119.66207 128.13390 01117     Shelby
```
